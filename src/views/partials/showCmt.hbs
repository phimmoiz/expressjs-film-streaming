<div class="flex flex-col">
  <div class="flex flex-row" data-testid="comment">
    <div class="flex-none">
      <img src="{{user.avatar}}" alt="avatar" class="w-12 h-12 rounded-full border">
    </div>
    <div class="flex-1">
      <div class="flex flex-col bg-gray-100 shadow-lg rounded-md px-4 pt-2 pb-3">
        <div class="flex flex-row justify-between items-center">
          <a href="/users/{{user.username}}"
            class="text-base font-bold text-pink-400 hover:text-pink-600">{{user.username}}</a>
          <i class="fas fa-heart text-pink-400"> {{likes.length}}</i>
        </div>
        <p class="text-black" data-testid="commentContent">{{content}}</p>
      </div>
      <div class="flex flex-row px-4 justify-between my-2">
        <div class="flex">
          <span class="text-xs text-gray-600 dark:text-gray-50">{{createdAt}}</span>
        </div>
        <div class="flex justify-end gap-4">
          <div class="flex-none">
            {{#ifBelong likes @root/user.id }}
            <a onclick="onLiked(this)" data-id="{{id}}"
              class="text-xs text-pink-600 dark:text-gray-50 hover:cursor-pointer">
              UnLike
            </a>
            {{else}}
            <a onclick="onLiked(this)" data-id="{{id}}"
              class="text-xs text-gray-600 dark:text-gray-50 hover:cursor-pointer">
              Like
            </a>
            {{/ifBelong}}
          </div>
          <div class="flex-none">
            <a onclick="onReplyButtonHandler(this)" data-id="{{id}}"
              class="text-xs text-gray-600 dark:text-gray-50 hover:cursor-pointer">Reply</a>
          </div>
          {{#ifEquals user._id @root/user.id}}
          <div class="flex-none">
            <a onclick="onDelete(this)" data-id="{{id}}"
              class="text-xs text-gray-600 dark:text-gray-50 hover:cursor-pointer">Delete</a>
          </div>
          {{/ifEquals}}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function onLiked(el) {
    const id = el.dataset.id;
    const url = `/comments/${id}/like`;
    const method = 'POST';
    const data = {
      _csrf: '{{@root/_csrfToken}}',
    };
    $.ajax({
      url: url,
      method: method,
      data: data,
      success: function (res) {
        if (res.success) {
          window.location.reload();
        }
      }
    });
  }

  const $globalReplyEl = $("[data-testid='comment'").first().clone();
  //$globalReplyEl.children().last().remove();

  //replace comment content with reply form
  $globalReplyEl.find("[data-testid='commentContent']").html(`
    <form class="flex flex-col" onsubmit="return false" x-data="{content: ''}">
      <textarea class="w-full h-12 p-2 border rounded-md" name="content" x-model="content" placeholder="Write a reply..." @keydown.enter="createComment(content)"></textarea>
      <input type="hidden" name="_csrf" value="{{@root/_csrfToken}}">
    </form>
  `);

  function onReplyButtonHandler(el) {
    const $grandParent = $(el).parent().parent().parent().parent();

    $grandParent.append($globalReplyEl);
  }

  function createComment(el) {
    const id = el.dataset.id;
    const url = `/comments/${id}/reply`;
    const method = 'POST';
    const data = {
      _csrf: '{{@root/_csrfToken}}',
    };
    $.ajax({
      url: url,
      method: method,
      data: data,
      success: function (res) {
        if (res.success) {
          window.location.reload();
        }
      }
    });
  }
  function onDelete(el) {
    const id = el.dataset.id;
    const url = `/comments/${id}`;
    const method = 'DELETE';
    const data = {
      _csrf: '{{@root/_csrfToken}}',
    };
    $.ajax({
      url: url,
      method: method,
      data: data,
      success: function (res) {
        if (res.success) {
          window.location.reload();
        }
      }
    });
  }

</script>